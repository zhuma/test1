webpackJsonp([2],{"0k87":function(t,e,o){o("SSy3"),t.exports=o("ZuHZ").Object.keys},A09H:function(t,e){},ERIZ:function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o("3cXf"),a=o.n(r),n=o("rVsN"),i=o.n(n),d=o("ZLEe"),s=o.n(d),m={components:{AddGoods:o("ozpw").a},data:function(){var t=this;return{warehouseArr:[],typeArr:[],departmentArr:[],provideModal:!1,provideForm:{date:(new Date).toLocaleDateString(),warehouse:"",warehouseName:"",type:"",department:"",leader:""},applyDepartArr:[],goodsCols:[{type:"index",title:"序号",align:"center",width:65,key:"sortNum"},{title:"物品名称",align:"center",key:"name"},{title:"物品编码",align:"center",key:"code"},{title:"物品分类",align:"center",key:"classify"},{title:"品牌",align:"center",key:"brand"},{title:"规格/型号",align:"center",key:"model"},{title:"单位",align:"center",key:"unit"},{title:"当前库存",align:"center",key:"currentInventory",render:function(e,o){return e("div",[e("span",{class:"zd-common-primary-c zd-common-cp",on:{click:function(e){e.stopPropagation(),t.showInventoryModal(o.index)}}},o.row.currentInventory)])}},{title:"出库数量",align:"center",slot:"number",key:"number",renderHeader:function(t,e){return t("div",[t("span",{class:"zd-cm-required"},"出库数量")])}},{title:"金额",align:"center",slot:"amount",key:"amount"}],formGoodsData:{attrData:[]},provideRemarkForm:{remark:""},ruleValidate:{date:[{required:!0,type:"date",message:"不能为空",trigger:"change"}],warehouse:[{required:!0,message:"不能为空",trigger:"change"}],type:[{required:!0,message:"不能为空",trigger:"change"}]},saveLoading:!1,leaderArr:[],loading:!1,date:"",userName:"",addGoodsIndex:null,addGoodsId:null,addGoodsModal:!1,delId:"",delIndex:"",code:"",editId:this.$route.params.id,editOrderNO:"",goodsName:"",outNumber:null,inventoryModal:!1,inventoryCols:[{type:"index",title:"序号",align:"center",width:65,key:"sortNum"},{title:"入库日期",align:"center",key:"date",width:110},{title:"入库单号",align:"center",key:"orderNO",width:140},{title:"入库价格",align:"center",key:"price",width:100},{title:"剩余数量",align:"center",key:"surplusNum",width:100},{title:"本次出库数量",align:"center",slot:"outNum",key:"outNum"},{title:"金额",align:"center",slot:"amount",key:"amount"}],inventoryData:{attrData:[]},tmpInventory:[],subInvArr:[]}},computed:{},created:function(){var t=this;this.getOutKindList().then(function(e){t.typeArr=e.data,t.getOutWarehouseRecordInfo(t.editId)}),this.getDepartment().then(function(e){t.departmentArr=e.data});var e=new Date;this.date=e.getFullYear()+"-"+this.fillZero(e.getMonth()+1)+"-"+this.fillZero(e.getDate()),this.$store.dispatch("getBaseInfo").then(function(e){t.remoteMethod(e.userName)})},methods:{getOutWarehouseRecordInfo:function(t){var e=this;BaseAxios({method:"post",url:" /sr/storeroomData!getOutWarehouseRecordInfo.action",data:{id:t}}).then(function(t){var o=t.data;s()(o).length>0&&(e.provideForm.date=new Date(o.date),e.provideForm.warehouse=o.warehouseId,e.provideForm.warehouseName=o.warehouseName,e.provideForm.type=o.kindCode,e.provideForm.department=o.departmentId,e.provideForm.leader=o.buyserId,e.provideRemarkForm.remark=o.note,o.goodsList.map(function(t){e.formGoodsData.attrData.push({id:t.goodsInfoId,name:t.goodsInfoName,code:t.code,classify:t.goodsKindName,brand:t.brand,model:t.size,unit:t.unit,number:t.goodsNum,currentInventory:t.inventory,amount:t.totalPrice})}),e.editOrderNO=o.num,e.editId=o.id,e.userName=o.userName,e.date=o.productDate)}).catch(function(t){e.postErrorTip("请求失败"),console.log(t)})},changeDate:function(t){this.provideForm.date=t},toOut:function(){this.$router.push({path:"/out"})},handleSummary:function(t){var e=t.columns,o=t.data,r={};return e.forEach(function(t,e){var a=t.key;if(0!==e){var n=o.map(function(t){return Number(t[a])});if(n.every(function(t){return isNaN(t)})||8!==e&&9!==e)r[a]={key:a,value:""};else{var i=n.reduce(function(t,e){var o=Number(e);return isNaN(o)?t:t+e},0);r[a]={key:a,value:i}}}else r[a]={key:a,value:"合计"}}),r},remoteMethod:function(t){var e=this;this.selectLeader(t).then(function(t){e.leaderArr=t.data})},addGoodsHandle:function(){if(""!==this.provideForm.warehouse){this.addGoodsModal=!0;var t=this.formGoodsData.attrData,e=[];t.map(function(t){e.push(t.id)}),this.$refs.child.getKind("1"),this.$refs.child.selectedArr=t.slice(),this.$refs.child.selectedArrId=e}else this.postWarningTip("请先选择出库仓库")},saveGoodsHandle:function(){this.addGoodsModal=!1,this.formGoodsData.attrData=this.$refs.child.selectedArr.slice(),this.getInventoryByParam(this.$refs.child.selectedArrId.join(","),this.provideForm.warehouse)},getCurrIndex:function(t){var e=this,o=!1,r=[];if(this.tmpInventory.map(function(a){if(a.id===e.formGoodsData.attrData[t].id)for(var n=0;n<a.arr.length;n++)if(null!==a.arr[n].outNum){r=a.arr,o=!0;break}}),o){var a=null;r.map(function(t){null!==t.outNum&&(a+=t.amount)}),this.formGoodsData.attrData[t].amount=a}else this.getGoodsList(this.formGoodsData.attrData[t].id,this.provideForm.warehouse).then(function(o){var r=o.data,a=null,n=e.formGoodsData.attrData[t].number;if(null!==n){for(var i=0;i<r.length;i++){if(r[i].inventory>=n){a+=parseFloat(r[i].unitPrice)*n;break}n-=r[i].inventory,a+=parseFloat(r[i].unitPrice)*r[i].inventory}e.formGoodsData.attrData[t].amount=a}else e.formGoodsData.attrData[t].amount=null})},getGoodsByCodeHandle:function(){""!==this.code?this.getGoodsByCode(this.code):this.postWarningTip("请输入物品编码进行添加")},getGoodsByCode:function(t){var e=this,o=this.formGoodsData.attrData.map(function(t){return t.id});this.getGoodsInfoByUseType("1","","",t).then(function(t){t.data.map(function(t){o.indexOf(t.id)<0&&(e.formGoodsData.attrData.push({id:t.id,name:t.name,code:t.code,classify:t.goodsKind,brand:t.brand,model:t.size,unit:t.unit,number:null,currentInventory:null,price:null,amount:null,priceList:[]}),e.getInventoryByParam(t.id,e.provideForm.warehouse))}),e.code=""})},getInventoryByParam:function(t,e){var o=this;BaseAxios({method:"post",url:"/sr/storeroomData!getInventoryByParam.action",data:{goodsInfoIds:t,warehouseId:e}}).then(function(t){var e=t.data,r=function(t){o.formGoodsData.attrData.map(function(r){r.id===t&&o.$set(r,"currentInventory",e[t].inventory)})};for(var a in e)r(a)}).catch(function(t){o.postErrorTip("请求失败"),console.log(t)})},getGoodsListInWarehouse:function(t,e){var o=this;this.getGoodsList(t,e).then(function(t){o.inventoryData.attrData=[];var e=t.data;if(null!==o.outNumber)for(var r=o.outNumber,a=0;a<e.length;a++){var n=null,i=e[a];i.inventory>=r?(n=r,r=0):(n=i.inventory,r-=i.inventory),o.inventoryData.attrData.push({id:i.recordGoodsId,recordKind:i.recordKind,date:i.date,orderNO:i.num,price:i.unitPrice,surplusNum:i.inventory,outNum:0===n?null:n,amount:0!==n&&null!==n?i.unitPrice*n:null})}else e.map(function(t){o.inventoryData.attrData.push({id:t.recordGoodsId,recordKind:t.recordKind,date:t.date,orderNO:t.num,price:t.unitPrice,surplusNum:t.inventory,outNum:0===t.outNum?null:t.outNum,amount:null})})})},getGoodsList:function(t,e){var o=this;return new i.a(function(r,a){BaseAxios({method:"post",url:"/sr/storeroomData!getOutWarehouseRecordDetail.action",data:{goodsInfoId:t,warehouseId:e,recordId:o.editId}}).then(function(t){r(t)})}).catch(function(t){reject(t)})},showInventoryModal:function(t){var e=this,o=!1,r=[];if(this.addGoodsIndex=t,this.inventoryModal=!0,this.addGoodsId=this.formGoodsData.attrData[t].id,this.goodsName=this.formGoodsData.attrData[t].name,this.outNumber=this.formGoodsData.attrData[t].number,null===this.outNumber)this.tmpInventory.map(function(t,o){t.id===e.addGoodsId&&e.tmpInventory.splice(o,1)});else for(var n=JSON.parse(a()(this.tmpInventory)),i=0;i<n.length;i++)if(n[i].id===this.addGoodsId){o=!0,r=n[i].arr;break}o?this.inventoryData.attrData=r:this.getGoodsListInWarehouse(this.formGoodsData.attrData[t].id,this.provideForm.warehouse)},handleInventorySummary:function(t){var e=t.columns,o=t.data,r={};return e.forEach(function(t,e){var a=t.key;if(0!==e){var n=o.map(function(t){return Number(t[a])});if(n.every(function(t){return isNaN(t)})||4!==e&&5!==e&&6!==e)r[a]={key:a,value:""};else{var i=n.reduce(function(t,e){var o=Number(e);return isNaN(o)?t:t+e},0);r[a]={key:a,value:i}}}else r[a]={key:a,value:"合计"}}),r},cancelInventoryModal:function(){this.inventoryModal=!1,this.$refs.inventoryData.resetFields()},confirmInventoryModal:function(){for(var t=this,e=this.inventoryData.attrData,o=!1,r=0;r<e.length;r++)if(null!==e[r].outNum){o=!0;break}if(o){this.tmpInventory.map(function(e,o){e.id===t.addGoodsId&&t.tmpInventory.splice(o,1)}),this.tmpInventory.push({id:this.addGoodsId,arr:e});var a=null;e.map(function(t){a+=t.outNum}),this.formGoodsData.attrData[this.addGoodsIndex].number=a}else this.formGoodsData.attrData[this.addGoodsIndex].number=null,this.tmpInventory.map(function(e,o){e.id===t.addGoodsId&&t.tmpInventory.splice(o,1)});this.getCurrIndex(this.addGoodsIndex),this.inventoryModal=!1},calcAmount:function(t){this.inventoryData.attrData[t].amount=this.inventoryData.attrData[t].price*this.inventoryData.attrData[t].outNum},saveOrUpdateIntoWarehouseRecord:function(t,e,o,r,a,n,i,d,s){var m=this,u=!0,l=!0,c={};this.subInvArr=[],c["warehouseRecord.date"]=t,c["warehouseRecord.warehouse.id"]=e,c["warehouseRecord.outKind"]=o,""!==r&&(c["warehouseRecord.department.id"]=r),""!==a&&(c["warehouseRecord.buyer.id"]=a),c["warehouseRecord.note"]=n,c["warehouseRecord.code"]=d,c["warehouseRecord.id"]=s,this.tmpInventory.length>0?(u=!1,this.tmpInventory.map(function(t){i.map(function(e,o){e.id===t.id?t.arr.map(function(t){null!==t.outNum&&m.subInvArr.push({id:t.id,recordKind:t.recordKind,outNum:t.outNum})}):m.getGoodsList(e.id,m.provideForm.warehouse).then(function(t){var o=t.data;if(null!==e.number){var r=e.number;o.map(function(t){var e=null;t.inventory>=r?(e=r,r=0):(e=t.inventory,r-=t.inventory),m.subInvArr.push({id:t.recordGoodsId,recordKind:t.recordKind,outNum:0===e?null:e})})}m.subInvArr.map(function(t,e){null!==t.outNum&&(c["outGoodsVOs["+e+"].recordGoodsId"]=t.id,c["outGoodsVOs["+e+"].count"]=t.outNum,c["outGoodsVOs["+e+"].recordKind"]=t.recordKind)})}),o===i.length-1&&(u=!0)})})):(l=!1,i.map(function(t,e){m.getGoodsList(t.id,m.provideForm.warehouse).then(function(e){var o=e.data;if(null!==t.number){var r=t.number;o.map(function(t){var e=null;t.inventory>=r?(e=r,r=0):(e=t.inventory,r-=t.inventory),m.subInvArr.push({id:t.recordGoodsId,recordKind:t.recordKind,outNum:0===e?null:e})})}m.subInvArr.map(function(t,e){null!==t.outNum&&(c["outGoodsVOs["+e+"].recordGoodsId"]=t.id,c["outGoodsVOs["+e+"].count"]=t.outNum,c["outGoodsVOs["+e+"].recordKind"]=t.recordKind)})}),e===i.length-1&&(l=!0)})),u&&l&&setTimeout(function(){BaseAxios({method:"post",url:"/sr/storeroomData!saveOrUpdateOutWarehouseRecord.action",data:c}).then(function(t){m.saveLoading=!1,m.toOut()}).catch(function(t){m.saveLoading=!1,m.postErrorTip("请求失败"),console.log(t)})},500)},handleSubmit:function(){var t=!1,e=!1;if(this.$refs.provideForm.validate(function(e){e&&(t=!0)}),this.formGoodsData.attrData.length<=0)this.postWarningTip("请添加物品");else if(this.$refs.formGoodsData.validate(function(t){t&&(e=!0)}),t&&e){this.saveLoading=!0;var o=new Date(this.provideForm.date),r=o.getFullYear()+"-"+this.fillZero(o.getMonth()+1)+"-"+this.fillZero(o.getDate());this.saveOrUpdateIntoWarehouseRecord(r,this.provideForm.warehouse,this.provideForm.type,this.provideForm.department,this.provideForm.leader,this.provideRemarkForm.remark,this.formGoodsData.attrData,this.editOrderNO,this.editId)}},clickRowHandle:function(t,e){window.event.stopPropagation(),this.delId===t.id?(this.delId="",this.delIndex=""):(this.delId=t.id,this.delIndex=e)},rowClassName:function(t,e){return this.delId===t.id?"demo-table-info-row":""},delRowHandle:function(){if(""===this.delIndex)return this.postWarningTip("请选择删除的物品");if(this.formGoodsData.attrData.splice(this.delIndex,1),this.$refs.child.selectedArrId.indexOf(this.delId)>-1){var t=this.$refs.child.selectedArrId.indexOf(this.delId);this.$refs.child.selectedArr.splice(t,1),this.$refs.child.selectedArrId.splice(t,1)}}},mounted:function(){}},u=o("W5g0");var l=function(t){o("A09H")},c=Object(u.a)(m,function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"zd-common-component"},[o("Form",{ref:"provideForm",staticClass:"zd-cm-applyForm",attrs:{model:t.provideForm,rules:t.ruleValidate,"label-width":80,inline:""}},[o("FormItem",{attrs:{label:"出库日期：",prop:"date"}},[o("DatePicker",{staticClass:"zd-common-input-h38 zd-common-w150 zd-common-mr10",attrs:{editable:!1,type:"date",format:"yyyy-MM-dd",placeholder:"出库日期"},model:{value:t.provideForm.date,callback:function(e){t.$set(t.provideForm,"date",e)},expression:"provideForm.date"}})],1),t._v(" "),o("FormItem",{attrs:{label:"出库仓库："}},[o("Input",{staticClass:"zd-common-input-h38 zd-common-w150 zd-common-mr10",attrs:{readonly:""},model:{value:t.provideForm.warehouseName,callback:function(e){t.$set(t.provideForm,"warehouseName","string"==typeof e?e.trim():e)},expression:"provideForm.warehouseName"}})],1),t._v(" "),o("FormItem",{attrs:{label:"出库类型：",prop:"type"}},[o("Select",{staticClass:"zd-common-input-h38 zd-common-w150 zd-common-mr10",attrs:{placeholder:"选择出库类型"},model:{value:t.provideForm.type,callback:function(e){t.$set(t.provideForm,"type",e)},expression:"provideForm.type"}},t._l(t.typeArr,function(e){return o("Option",{key:e.code,attrs:{value:e.code}},[t._v(t._s(e.name))])}),1)],1),t._v(" "),o("FormItem",{attrs:{label:"部门：",prop:"department","label-width":40}},[o("Select",{staticClass:"zd-common-input-h38 zd-common-w200 zd-common-mr10",attrs:{placeholder:"选择领用部门"},model:{value:t.provideForm.department,callback:function(e){t.$set(t.provideForm,"department",e)},expression:"provideForm.department"}},t._l(t.departmentArr,function(e){return o("Option",{key:e.id,attrs:{value:e.id}},[t._v(t._s(e.name))])}),1)],1),t._v(" "),o("FormItem",{attrs:{label:"领用人：",prop:"leader","label-width":50}},[o("Select",{ref:"leader",staticClass:"zd-common-input-h38 zd-common-w150 zd-common-fl",attrs:{placeholder:"请输入领用人",filterable:"",remote:"","remote-method":t.remoteMethod,loading:t.loading},model:{value:t.provideForm.leader,callback:function(e){t.$set(t.provideForm,"leader",e)},expression:"provideForm.leader"}},t._l(t.leaderArr,function(e){return o("Option",{key:e.id,attrs:{value:e.id}},[t._v(t._s(e.name))])}),1)],1)],1),t._v(" "),o("div",{staticClass:"zd-common-black-b zd-common-pt5 zd-common-pb5 zd-common-pl20"},[o("Button",{staticClass:"zd-common-mr10 zd-common-h32 zd-common-lh8",attrs:{type:"default"},on:{click:t.delRowHandle}},[t._v("\n      删除\n    ")])],1),t._v(" "),o("Form",{ref:"formGoodsData",staticClass:"zd-common-mt10",attrs:{model:t.formGoodsData}},[o("Table",{staticClass:"zd-common-overflow-v",attrs:{border:"",columns:t.goodsCols,data:t.formGoodsData.attrData,"show-summary":"","summary-method":t.handleSummary,"row-class-name":t.rowClassName},on:{"on-row-click":t.clickRowHandle},scopedSlots:t._u([{key:"number",fn:function(e){e.row;var r=e.index;return[t.formGoodsData.attrData[r].currentInventory>0?o("Form-item",{staticClass:"zd-common-mt24",attrs:{prop:"attrData."+r+".number",rules:{required:!0,message:"不能为空",trigger:"blur",type:"number"}}},[o("InputNumber",{attrs:{max:t.formGoodsData.attrData[r].currentInventory,min:1,precision:0,placeholder:"数量"},on:{"on-change":function(e){return t.getCurrIndex(r)}},model:{value:t.formGoodsData.attrData[r].number,callback:function(e){t.$set(t.formGoodsData.attrData[r],"number",e)},expression:"formGoodsData.attrData[index].number"}})],1):o("Form-item",{staticClass:"zd-common-mt24",attrs:{prop:"attrData."+r+".number",rules:{required:!0,message:"不能为空",trigger:"blur",type:"number"}}},[o("InputNumber",{attrs:{readonly:""},model:{value:t.formGoodsData.attrData[r].number,callback:function(e){t.$set(t.formGoodsData.attrData[r],"number",e)},expression:"formGoodsData.attrData[index].number"}})],1)]}},{key:"amount",fn:function(e){e.row;var o=e.index;return[t._v("\n        "+t._s(t.formGoodsData.attrData[o].amount)+"\n      ")]}}])})],1),t._v(" "),o("div",{staticClass:"zd-common-mt10 zd-common-clearFix"},[o("span",{staticClass:"zd-common-fl"},[t._v("制单人："+t._s(t.userName))]),t._v(" "),o("span",{staticClass:"zd-common-fl zd-common-ml20"},[t._v("制单日期："+t._s(t.date))])]),t._v(" "),o("Form",{ref:"provideRemarkForm",staticClass:"zd-common-mt20",attrs:{model:t.provideRemarkForm}},[o("FormItem",{staticClass:"zd-common-mb0",attrs:{label:"备注："}},[o("Input",{staticClass:"zd-common-fl",staticStyle:{width:"826px"},attrs:{placeholder:"备注",maxlength:100,type:"textarea",autosize:{minRows:5,maxRows:5}},model:{value:t.provideRemarkForm.remark,callback:function(e){t.$set(t.provideRemarkForm,"remark","string"==typeof e?e.trim():e)},expression:"provideRemarkForm.remark"}})],1)],1),t._v(" "),o("div",{staticClass:"zd-common-modal-footer zd-common-pt30",attrs:{slot:"footer"},slot:"footer"},[o("Button",{staticClass:"zd-common-mr35 zd-common-w100 zd-common-h32 zd-common-lh8",attrs:{type:"primary",loading:t.saveLoading},on:{click:t.handleSubmit}},[t.saveLoading?o("span",[t._v("正在保存...")]):o("span",[t._v("确定")])]),t._v(" "),o("Button",{staticClass:"zd-common-w100 zd-common-h32 zd-common-lh8",on:{click:t.toOut}},[t._v("取消")])],1),t._v(" "),o("Modal",{attrs:{"mask-closable":!1,width:920},on:{"on-cancel":t.cancelInventoryModal},model:{value:t.inventoryModal,callback:function(e){t.inventoryModal=e},expression:"inventoryModal"}},[o("h3",{staticClass:"zd-common-modal-header",attrs:{slot:"header"},slot:"header"},[o("span",[t._v(t._s(t.goodsName))])]),t._v(" "),o("div",{staticClass:"zd-common-tr"},[o("i",{staticClass:"zd-common-fs12 zd-common-font-style zd-common-des-font-c"},[t._v("系统默认按照先入先出的原则自动分配出库数量")])]),t._v(" "),o("div",{staticClass:"zd-common-h400 zd-common-mt10"},[o("vue-scroll",[o("Form",{ref:"inventoryData",attrs:{model:t.inventoryData}},[o("Table",{staticClass:"zd-common-overflow-v zd-cm-out-table",attrs:{border:"",columns:t.inventoryCols,data:t.inventoryData.attrData,"show-summary":"","summary-method":t.handleInventorySummary},scopedSlots:t._u([{key:"outNum",fn:function(e){e.row;var r=e.index;return t.inventoryData.attrData[r].surplusNum>0?[o("Form-item",{staticClass:"zd-common-mt24"},[o("InputNumber",{attrs:{max:t.inventoryData.attrData[r].surplusNum,min:1,precision:0,placeholder:"数量"},on:{"on-change":function(e){return t.calcAmount(r)}},model:{value:t.inventoryData.attrData[r].outNum,callback:function(e){t.$set(t.inventoryData.attrData[r],"outNum",e)},expression:"inventoryData.attrData[index].outNum"}})],1)]:void 0}},{key:"amount",fn:function(e){e.row;var o=e.index;return[t._v("\n              "+t._s(t.inventoryData.attrData[o].amount)+"\n            ")]}}],null,!0)})],1)],1)],1),t._v(" "),o("div",{staticClass:"zd-common-modal-footer zd-common-pt10",attrs:{slot:"footer"},slot:"footer"},[o("Button",{staticClass:"zd-common-mr35 zd-common-w100 zd-common-h32 zd-common-lh8",attrs:{type:"primary"},on:{click:t.confirmInventoryModal}},[t._v("确定")]),t._v(" "),o("Button",{staticClass:"zd-common-w100 zd-common-h32 zd-common-lh8",on:{click:t.cancelInventoryModal}},[t._v("取消")])],1)])],1)},[],!1,l,"data-v-1ed4ba0e",null);e.default=c.exports},SSy3:function(t,e,o){var r=o("WXuS"),a=o("RY2v");o("adHB")("keys",function(){return function(t){return a(r(t))}})},ZLEe:function(t,e,o){t.exports={default:o("0k87"),__esModule:!0}}});
//# sourceMappingURL=2.aa7a4f0a713f62f40b93.js.map